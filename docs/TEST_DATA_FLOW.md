# OEM 견적 시스템 테스트 - 상세 데이터 흐름

> 테스트 실행일시: 2025-12-04 11:32:18

이 문서는 각 테스트 시나리오에서 **입력 → 처리 → 출력** 데이터를 상세히 기록합니다.

---

## 테스트 1: 기본 견적 계산

### 입력 데이터
```json
{
  "product_type": "환",
  "gram_per_pouch": 5,
  "pouch_per_box": 30,
  "boxes": 3000,
  "ingredient_ratios": {
    "차전자피": 80,
    "결정셀룰로스": 10,
    "정제포도당": 8,
    "이산화규소": 1,
    "스테아린산마그네슘": 1
  }
}
```

### 처리 과정

**1. 총 원료량 계산**
```
total_kg = 5g × 30포 × 3000박스 / 1000
total_kg = 450.0kg
```

**2. 원료비 계산**

| 원료 | 비율 | 사용량(kg) | 단가(원/kg) | 금액(원) |
|------|------|-----------|-------------|----------|
| 차전자피 | 80% | 360.0kg | 8,500원 | 3,060,000원 |
| 결정셀룰로스 | 10% | 45.0kg | 3,500원 | 157,500원 |
| 정제포도당 | 8% | 36.0kg | 2,500원 | 90,000원 |
| 이산화규소 | 1% | 4.5kg | 8,000원 | 36,000원 |
| 스테아린산마그네슘 | 1% | 4.5kg | 6,000원 | 27,000원 |
| **합계** | 100% | 450.0kg | - | **3,370,500원** |

**3. 포장비 계산**

| 항목 | 수량 | 단가 | 금액 |
|------|------|------|------|
| 스틱포장 | 90,000포 | 35원/포 | 3,150,000원 |
| 단박스 | 3,000개 | 400원/개 | 1,200,000원 |
| **합계** | - | - | **4,350,000원** |

**4. 임가공비 계산**

| 제형 | 원료량 | 단가 | 금액 |
|------|--------|------|------|
| 환 | 450.0kg | 11,000원/kg | 4,950,000원 |

### 출력 데이터
```json
{
  "product_spec": {
    "product_type": "환",
    "total_kg": 450.0,
    "total_pouches": 90000,
    "boxes": 3000
  },
  "costs": {
    "ingredient_cost": 3370500,
    "packaging_cost": 4350000,
    "processing_cost": 4950000,
    "total_cost": 12670500,
    "price_per_box": 4223
  },
  "moq_applied": false,
  "warnings": []
}
```

---

## 테스트 2: MOQ 자동 적용

### 입력 데이터
```json
{
  "product_type": "환",
  "gram_per_pouch": 5,
  "pouch_per_box": 30,
  "boxes": 1000,
  "ingredient_ratios": {
    "차전자피": 80,
    "결정셀룰로스": 20
  }
}
```

### 처리 과정

**MOQ 규칙 확인**
```json
{
  "default_moq_boxes": 2000,
  "default_pouch_per_box": 30,
  "default_gram_per_pouch": 5,
  "min_production_kg": 300
}
```

**MOQ 적용 로직**
```
요청 박스: 1000박스
최소 박스: 2000박스
요청 < 최소 → MOQ 적용
적용 박스: 2000박스
```

### 출력 데이터
```json
{
  "original_boxes": 1000,
  "applied_boxes": 2000,
  "moq_applied": true,
  "warnings": [
    "MOQ 적용: 1000박스 → 2000박스로 조정됨"
  ],
  "total_cost": 8450000
}
```

---

## 테스트 3: 부형제 자동 추천

### 입력 데이터
```json
{
  "main_ratio": 80
}
```

### 처리 과정

**기본 부형제 비율 (DEFAULT_EXCIPIENTS)**
```python
DEFAULT_EXCIPIENTS = {
    "결정셀룰로스": 10,  # 충전제
    "정제포도당": 8,     # 감미료
    "이산화규소": 1,     # 유동화제
    "스테아린산마그네슘": 1,  # 활택제
}
```

**스케일링 계산**
```
남은 비율 = 100% - 80% = 20%
기본 합계 = 10 + 8 + 1 + 1 = 20
스케일 = 20 / 20 = 1.0
```

### 출력 데이터
```json
{
  "main_ratio": 80,
  "excipients": {
    "결정셀룰로스": 10.0,
    "정제포도당": 8.0,
    "이산화규소": 1.0,
    "스테아린산마그네슘": 1.0
  },
  "total_ratio": 100.0
}
```

---

## 테스트 4: 레퍼런스 제품 조회

### 입력 데이터
```json
{
  "ingredient_name": "차전자피"
}
```

### DB 원본 데이터 (ingredient_db.json)
```json
[
  {
    "name": "종근당건강 차전자피 환",
    "ratio": {
      "차전자피": 95,
      "결정셀룰로스": 5
    }
  },
  {
    "name": "홍진경 차전자피 환",
    "ratio": {
      "차전자피": 70,
      "정제포도당": 20,
      "탄산마그네슘": 10
    }
  },
  {
    "name": "차전자피 100% 환",
    "ratio": {
      "차전자피": 100
    }
  }
]
```

### 출력 데이터
```json
[
  {
    "name": "종근당건강 차전자피 환",
    "source": "db",
    "ratio": {
      "차전자피": 95,
      "결정셀룰로스": 5
    }
  },
  {
    "name": "홍진경 차전자피 환",
    "source": "db",
    "ratio": {
      "차전자피": 70,
      "정제포도당": 20,
      "탄산마그네슘": 10
    }
  },
  {
    "name": "차전자피 100% 환",
    "source": "db",
    "ratio": {
      "차전자피": 100
    }
  }
]
```

---

## 테스트 5: 제형별 임가공비

### 입력 데이터 (공통)
```json
{
  "gram_per_pouch": 5,
  "pouch_per_box": 30,
  "boxes": 3000,
  "ingredient_ratios": {
    "차전자피": 80,
    "결정셀룰로스": 20
  },
  "product_types": [
    "환",
    "분말",
    "정제",
    "과립"
  ]
}
```

### DB 원본 데이터 (processing_costs)
```json
{
  "제환비": {
    "unit": "원/kg",
    "price": 11000,
    "description": "분말을 환 형태로 성형"
  },
  "분말충진비": {
    "unit": "원/kg",
    "price": 8000,
    "description": "분말 스틱 충진"
  },
  "정제비": {
    "unit": "원/kg",
    "price": 15000,
    "description": "정제 타정"
  },
  "과립비": {
    "unit": "원/kg",
    "price": 12000,
    "description": "과립 성형"
  }
}
```

### 처리 및 출력 데이터

| 제형 | processing_cost_key | 단가 | 원료량 | 임가공비 |
|------|---------------------|------|--------|----------|
| 환 | 제환비 | 11,000원/kg | 450.0kg | 4,950,000원 |
| 분말 | 분말충진비 | 8,000원/kg | 450.0kg | 3,600,000원 |
| 정제 | 정제비 | 15,000원/kg | 450.0kg | 6,750,000원 |
| 과립 | 과립비 | 12,000원/kg | 450.0kg | 5,400,000원 |

---

## 테스트 6: 배합비 제안

### Case A: 비율 미지정 (레퍼런스 기준)

**입력**
```json
{
  "ingredient_name": "차전자피",
  "main_ratio": null
}
```

**출력** (첫 번째 레퍼런스 제품 비율 사용)
```json
{
  "차전자피": 95,
  "결정셀룰로스": 5
}
```

### Case B: 주원료 70% 지정

**입력**
```json
{
  "ingredient_name": "차전자피",
  "main_ratio": 70
}
```

**출력** (부형제 자동 추천)
```json
{
  "차전자피": 70,
  "결정셀룰로스": 15.0,
  "정제포도당": 12.0,
  "이산화규소": 1.5,
  "스테아린산마그네슘": 1.5
}
```

---

## 테스트 7: 원료비 계산 정확도

### 입력 데이터
```json
{
  "ratios": {
    "차전자피": 100
  },
  "total_kg": 450
}
```

### 처리 과정
```
차전자피 단가: 8,500원/kg
사용량: 450kg × 100% = 450kg
원료비: 450kg × 8,500원 = 3,825,000원
```

### 출력 데이터
```json
{
  "details": [
    {
      "name": "차전자피",
      "ratio": 100,
      "kg": 450.0,
      "price_per_kg": 8500,
      "cost": 3825000
    }
  ],
  "total_cost": 3825000,
  "missing_ingredients": []
}
```

---

## 전체 데이터 흐름 요약

```
┌─────────────────────────────────────────────────────────────┐
│                        입력 (Input)                          │
├─────────────────────────────────────────────────────────────┤
│  ProductSpec:                                                │
│    - product_type: 환/분말/정제/과립                          │
│    - gram_per_pouch: 1포당 그램                               │
│    - pouch_per_box: 1박스당 포수                              │
│    - boxes: 총 박스 수                                        │
│    - ingredient_ratios: {원료: 비율, ...}                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     처리 (Processing)                        │
├─────────────────────────────────────────────────────────────┤
│  1. MOQ 적용 (QuoteCalculator._apply_moq)                    │
│     └─ boxes < 2000 or total_kg < 300 → 자동 조정            │
│                                                              │
│  2. 원료비 계산 (IngredientService.calculate_ingredient_cost)│
│     └─ Σ(total_kg × ratio × price_per_kg)                    │
│                                                              │
│  3. 포장비 계산 (QuoteCalculator._calculate_packaging_cost)  │
│     └─ (pouches × 35원) + (boxes × 400원)                    │
│                                                              │
│  4. 임가공비 계산 (QuoteCalculator._calculate_processing_cost│
│     └─ total_kg × processing_price                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       출력 (Output)                          │
├─────────────────────────────────────────────────────────────┤
│  QuoteResult:                                                │
│    - ingredient_cost: 원료비                                  │
│    - packaging_cost: 포장비                                   │
│    - processing_cost: 임가공비                                │
│    - total_cost: 총 금액                                      │
│    - price_per_box: 박스당 단가                               │
│    - moq_applied: MOQ 적용 여부                               │
│    - warnings: 경고 메시지                                    │
│    - ingredient_details: 원료별 상세                          │
│    - packaging_details: 포장 상세                             │
│    - processing_details: 임가공 상세                          │
└─────────────────────────────────────────────────────────────┘
```